#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Pentest Utilities Module
Shared utilities for security demonstration tools
Features: Demo mode, HTML Reports, Visual Risk Scoring
"""

import os
import sys
import json
import html
from datetime import datetime
from typing import Dict, List, Optional, Any, Tuple
from dataclasses import dataclass, field, asdict
from enum import Enum

# ==================== RISK SCORING ====================

class RiskLevel(Enum):
    """Risk levels with visual indicators"""
    CRITICAL = ("CRITICAL", "\033[91m", "üî¥", "#dc3545", 10)
    HIGH = ("HIGH", "\033[91m", "üü†", "#fd7e14", 7)
    MEDIUM = ("MEDIUM", "\033[93m", "üü°", "#ffc107", 4)
    LOW = ("LOW", "\033[92m", "üü¢", "#28a745", 1)
    INFO = ("INFO", "\033[94m", "üîµ", "#17a2b8", 0)

    def __init__(self, label: str, ansi_color: str, emoji: str, html_color: str, score: int):
        self.label = label
        self.ansi_color = ansi_color
        self.emoji = emoji
        self.html_color = html_color
        self.score = score

    def colored_label(self, use_emoji: bool = True) -> str:
        """Return colored label for terminal output"""
        reset = "\033[0m"
        prefix = f"{self.emoji} " if use_emoji else ""
        return f"{self.ansi_color}{prefix}[{self.label}]{reset}"

    def html_badge(self) -> str:
        """Return HTML badge for reports"""
        return f'<span class="badge" style="background-color: {self.html_color}; color: white; padding: 3px 8px; border-radius: 4px; font-weight: bold;">{self.label}</span>'


@dataclass
class Finding:
    """Represents a security finding"""
    title: str
    description: str
    risk: RiskLevel
    port: Optional[int] = None
    service: Optional[str] = None
    evidence: Optional[str] = None
    recommendation: Optional[str] = None
    cvss: Optional[float] = None
    cve: Optional[str] = None

    def to_dict(self) -> Dict[str, Any]:
        """Convert to dictionary for JSON export"""
        return {
            "title": self.title,
            "description": self.description,
            "risk": self.risk.label,
            "port": self.port,
            "service": self.service,
            "evidence": self.evidence,
            "recommendation": self.recommendation,
            "cvss": self.cvss,
            "cve": self.cve
        }


@dataclass
class ScanResult:
    """Represents complete scan results"""
    target: str
    scan_type: str
    start_time: datetime = field(default_factory=datetime.now)
    end_time: Optional[datetime] = None
    findings: List[Finding] = field(default_factory=list)
    raw_output: str = ""
    demo_mode: bool = False

    def add_finding(self, finding: Finding):
        """Add a finding to results"""
        self.findings.append(finding)

    def get_risk_summary(self) -> Dict[str, int]:
        """Get count of findings by risk level"""
        summary = {level.label: 0 for level in RiskLevel}
        for finding in self.findings:
            summary[finding.risk.label] += 1
        return summary

    def get_total_score(self) -> int:
        """Calculate total risk score"""
        return sum(f.risk.score for f in self.findings)

    def get_max_risk(self) -> RiskLevel:
        """Get highest risk level found"""
        if not self.findings:
            return RiskLevel.INFO
        return max(self.findings, key=lambda f: f.risk.score).risk


# ==================== DEMO MODE ====================

class DemoMode:
    """Demo mode manager - shows what WOULD happen without executing"""

    def __init__(self, enabled: bool = False):
        self.enabled = enabled
        self.logged_actions: List[Dict[str, Any]] = []

    def log_action(self, action_type: str, command: str, description: str,
                   risk_level: str = "INFO") -> None:
        """Log an action that would be performed"""
        action = {
            "timestamp": datetime.now().isoformat(),
            "type": action_type,
            "command": command,
            "description": description,
            "risk_level": risk_level,
            "executed": not self.enabled
        }
        self.logged_actions.append(action)

        if self.enabled:
            self._print_demo_action(action)

    def _print_demo_action(self, action: Dict[str, Any]) -> None:
        """Print demo action to terminal"""
        yellow = "\033[93m"
        cyan = "\033[96m"
        reset = "\033[0m"

        print(f"\n{yellow}{'='*60}")
        print(f"  üé≠ DEMO MODE - Action simul√©e")
        print(f"{'='*60}{reset}")
        print(f"{cyan}Type:{reset} {action['type']}")
        print(f"{cyan}Commande:{reset} {action['command']}")
        print(f"{cyan}Description:{reset} {action['description']}")
        print(f"{cyan}Risque:{reset} {action['risk_level']}")
        print(f"{yellow}{'='*60}{reset}\n")

    def should_execute(self, command: str, description: str,
                       action_type: str = "COMMAND", risk_level: str = "INFO") -> bool:
        """Check if action should execute (False in demo mode)"""
        self.log_action(action_type, command, description, risk_level)
        return not self.enabled

    def get_summary(self) -> str:
        """Get summary of all logged actions"""
        if not self.logged_actions:
            return "Aucune action enregistr√©e."

        lines = [
            "\n" + "="*60,
            "  üìã R√âSUM√â DES ACTIONS (Mode D√©mo)",
            "="*60,
            f"  Total: {len(self.logged_actions)} action(s)\n"
        ]

        for i, action in enumerate(self.logged_actions, 1):
            status = "‚è∏Ô∏è SIMUL√â" if not action['executed'] else "‚úÖ EX√âCUT√â"
            lines.append(f"  {i}. [{status}] {action['type']}: {action['command'][:50]}...")

        lines.append("="*60 + "\n")
        return "\n".join(lines)


# ==================== HTML REPORT GENERATOR ====================

class HTMLReportGenerator:
    """Generate professional HTML reports"""

    HTML_TEMPLATE = """<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapport de S√©curit√© - {target}</title>
    <style>
        * {{ box-sizing: border-box; margin: 0; padding: 0; }}
        body {{
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }}
        .container {{ max-width: 1200px; margin: 0 auto; }}
        .header {{
            background: linear-gradient(90deg, #0f3460 0%, #533483 100%);
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }}
        .header h1 {{ font-size: 2em; margin-bottom: 10px; }}
        .header .meta {{ color: #aaa; font-size: 0.9em; }}
        .demo-banner {{
            background: #ff9800;
            color: #000;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }}
        .summary-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }}
        .summary-card {{
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }}
        .summary-card .count {{ font-size: 2.5em; font-weight: bold; }}
        .summary-card .label {{ color: #aaa; margin-top: 5px; }}
        .risk-score {{
            background: rgba(255,255,255,0.1);
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }}
        .risk-score .score {{ font-size: 4em; font-weight: bold; }}
        .risk-score .max-risk {{ font-size: 1.2em; margin-top: 10px; }}
        .findings {{ margin-bottom: 20px; }}
        .finding {{
            background: rgba(255,255,255,0.05);
            border-left: 4px solid;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 0 10px 10px 0;
        }}
        .finding.critical {{ border-color: #dc3545; }}
        .finding.high {{ border-color: #fd7e14; }}
        .finding.medium {{ border-color: #ffc107; }}
        .finding.low {{ border-color: #28a745; }}
        .finding.info {{ border-color: #17a2b8; }}
        .finding h3 {{ margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }}
        .finding .details {{ color: #ccc; margin-top: 10px; }}
        .finding .evidence {{
            background: #000;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            margin-top: 10px;
            overflow-x: auto;
        }}
        .badge {{
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }}
        .raw-output {{
            background: #000;
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }}
        .section {{ margin-bottom: 30px; }}
        .section h2 {{
            border-bottom: 2px solid #533483;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }}
        .footer {{
            text-align: center;
            color: #666;
            padding: 20px;
            border-top: 1px solid #333;
            margin-top: 30px;
        }}
        @media print {{
            body {{ background: white; color: black; }}
            .finding {{ break-inside: avoid; }}
        }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Rapport de S√©curit√©</h1>
            <div class="meta">
                <p><strong>Cible:</strong> {target}</p>
                <p><strong>Type de scan:</strong> {scan_type}</p>
                <p><strong>Date:</strong> {date}</p>
                <p><strong>Dur√©e:</strong> {duration}</p>
            </div>
        </div>

        {demo_banner}

        <div class="summary-grid">
            <div class="summary-card" style="border-left: 4px solid #dc3545;">
                <div class="count" style="color: #dc3545;">{critical_count}</div>
                <div class="label">CRITIQUE</div>
            </div>
            <div class="summary-card" style="border-left: 4px solid #fd7e14;">
                <div class="count" style="color: #fd7e14;">{high_count}</div>
                <div class="label">√âLEV√â</div>
            </div>
            <div class="summary-card" style="border-left: 4px solid #ffc107;">
                <div class="count" style="color: #ffc107;">{medium_count}</div>
                <div class="label">MOYEN</div>
            </div>
            <div class="summary-card" style="border-left: 4px solid #28a745;">
                <div class="count" style="color: #28a745;">{low_count}</div>
                <div class="label">FAIBLE</div>
            </div>
            <div class="summary-card" style="border-left: 4px solid #17a2b8;">
                <div class="count" style="color: #17a2b8;">{info_count}</div>
                <div class="label">INFO</div>
            </div>
        </div>

        <div class="risk-score">
            <div class="score" style="color: {max_risk_color};">{total_score}</div>
            <div class="label">Score de Risque Total</div>
            <div class="max-risk">Risque Maximum: {max_risk_badge}</div>
        </div>

        <div class="section findings">
            <h2>üìã D√©couvertes ({findings_count})</h2>
            {findings_html}
        </div>

        <div class="section">
            <h2>üìÑ Sortie Brute</h2>
            <div class="raw-output">{raw_output}</div>
        </div>

        <div class="footer">
            <p>G√©n√©r√© par DarkScan Security Tools</p>
            <p>Ce rapport est destin√© √† un usage interne uniquement</p>
        </div>
    </div>
</body>
</html>"""

    @classmethod
    def generate(cls, result: ScanResult, output_path: Optional[str] = None) -> str:
        """Generate HTML report from scan results"""

        # Calculate duration
        if result.end_time:
            duration = result.end_time - result.start_time
            duration_str = str(duration).split('.')[0]
        else:
            duration_str = "En cours..."

        # Get risk summary
        summary = result.get_risk_summary()
        max_risk = result.get_max_risk()

        # Generate findings HTML
        findings_html = ""
        for finding in sorted(result.findings, key=lambda f: -f.risk.score):
            findings_html += cls._generate_finding_html(finding)

        if not findings_html:
            findings_html = '<p style="color: #aaa; text-align: center; padding: 40px;">Aucune d√©couverte pour ce scan.</p>'

        # Demo banner
        demo_banner = ""
        if result.demo_mode:
            demo_banner = '<div class="demo-banner">üé≠ MODE D√âMO - Ce scan a √©t√© simul√©, aucune action r√©elle n\'a √©t√© effectu√©e</div>'

        # Generate final HTML
        html_content = cls.HTML_TEMPLATE.format(
            target=html.escape(result.target),
            scan_type=html.escape(result.scan_type),
            date=result.start_time.strftime("%Y-%m-%d %H:%M:%S"),
            duration=duration_str,
            demo_banner=demo_banner,
            critical_count=summary.get("CRITICAL", 0),
            high_count=summary.get("HIGH", 0),
            medium_count=summary.get("MEDIUM", 0),
            low_count=summary.get("LOW", 0),
            info_count=summary.get("INFO", 0),
            total_score=result.get_total_score(),
            max_risk_color=max_risk.html_color,
            max_risk_badge=max_risk.html_badge(),
            findings_count=len(result.findings),
            findings_html=findings_html,
            raw_output=html.escape(result.raw_output or "Aucune sortie brute disponible.")
        )

        # Save to file if path provided
        if output_path:
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(html_content)

        return html_content

    @classmethod
    def _generate_finding_html(cls, finding: Finding) -> str:
        """Generate HTML for a single finding"""
        risk_class = finding.risk.label.lower()

        details = []
        if finding.port:
            details.append(f"<strong>Port:</strong> {finding.port}")
        if finding.service:
            details.append(f"<strong>Service:</strong> {html.escape(finding.service)}")
        if finding.cvss:
            details.append(f"<strong>CVSS:</strong> {finding.cvss}")
        if finding.cve:
            details.append(f"<strong>CVE:</strong> {html.escape(finding.cve)}")

        evidence_html = ""
        if finding.evidence:
            evidence_html = f'<div class="evidence">{html.escape(finding.evidence)}</div>'

        recommendation_html = ""
        if finding.recommendation:
            recommendation_html = f'<p style="margin-top: 10px;"><strong>üí° Recommandation:</strong> {html.escape(finding.recommendation)}</p>'

        return f"""
        <div class="finding {risk_class}">
            <h3>{finding.risk.html_badge()} {html.escape(finding.title)}</h3>
            <p>{html.escape(finding.description)}</p>
            <div class="details">
                {' | '.join(details)}
            </div>
            {evidence_html}
            {recommendation_html}
        </div>
        """


# ==================== TERMINAL OUTPUT HELPERS ====================

class TerminalOutput:
    """Helper for formatted terminal output with risk levels"""

    COLORS = {
        'red': '\033[91m',
        'green': '\033[92m',
        'yellow': '\033[93m',
        'blue': '\033[94m',
        'magenta': '\033[95m',
        'cyan': '\033[96m',
        'white': '\033[97m',
        'bold': '\033[1m',
        'reset': '\033[0m'
    }

    @classmethod
    def print_risk(cls, message: str, risk: RiskLevel, use_emoji: bool = True):
        """Print message with risk level indicator"""
        print(f"{risk.colored_label(use_emoji)} {message}")

    @classmethod
    def print_banner(cls, title: str, char: str = "=", width: int = 60):
        """Print a formatted banner"""
        print(f"\n{cls.COLORS['cyan']}{char * width}")
        print(f"  {title}")
        print(f"{char * width}{cls.COLORS['reset']}\n")

    @classmethod
    def print_table(cls, headers: List[str], rows: List[List[str]],
                    risk_column: Optional[int] = None):
        """Print a formatted table"""
        # Calculate column widths
        widths = [len(h) for h in headers]
        for row in rows:
            for i, cell in enumerate(row):
                if i < len(widths):
                    widths[i] = max(widths[i], len(str(cell)))

        # Print header
        header_line = " | ".join(h.ljust(widths[i]) for i, h in enumerate(headers))
        print(f"{cls.COLORS['bold']}{header_line}{cls.COLORS['reset']}")
        print("-" * (sum(widths) + 3 * (len(widths) - 1)))

        # Print rows
        for row in rows:
            cells = []
            for i, cell in enumerate(row):
                cell_str = str(cell).ljust(widths[i]) if i < len(widths) else str(cell)

                # Color risk column
                if risk_column is not None and i == risk_column:
                    try:
                        risk = RiskLevel[str(cell).upper()]
                        cell_str = f"{risk.ansi_color}{cell_str}{cls.COLORS['reset']}"
                    except KeyError:
                        pass

                cells.append(cell_str)

            print(" | ".join(cells))

    @classmethod
    def print_summary(cls, result: ScanResult):
        """Print a visual summary of scan results"""
        summary = result.get_risk_summary()
        max_risk = result.get_max_risk()

        cls.print_banner(f"R√âSUM√â - {result.target}")

        print(f"  Type de scan: {result.scan_type}")
        print(f"  Score total:  {result.get_total_score()}")
        print(f"  Risque max:   {max_risk.colored_label()}")
        print()

        # Visual bar chart
        max_count = max(summary.values()) if summary.values() else 1
        for level in RiskLevel:
            count = summary.get(level.label, 0)
            bar_width = int((count / max_count) * 30) if max_count > 0 else 0
            bar = "‚ñà" * bar_width + "‚ñë" * (30 - bar_width)
            print(f"  {level.colored_label():30} {bar} {count}")

        print()


# ==================== CONVENIENCE FUNCTIONS ====================

def create_demo_finding() -> Finding:
    """Create a sample finding for demonstration"""
    return Finding(
        title="Service SSH avec authentification faible",
        description="Le serveur SSH autorise l'authentification par mot de passe, ce qui le rend vuln√©rable aux attaques par force brute.",
        risk=RiskLevel.HIGH,
        port=22,
        service="OpenSSH 7.9",
        evidence="SSH-2.0-OpenSSH_7.9\nPasswordAuthentication yes",
        recommendation="D√©sactiver l'authentification par mot de passe et utiliser uniquement des cl√©s SSH."
    )


def demo_report_example():
    """Generate a demo report to show capabilities"""
    result = ScanResult(
        target="192.168.1.100",
        scan_type="Full Security Scan",
        demo_mode=True
    )

    # Add sample findings
    result.add_finding(Finding(
        title="Port SMB ouvert sans authentification",
        description="Le partage SMB est accessible sans authentification.",
        risk=RiskLevel.CRITICAL,
        port=445,
        service="Samba 4.7",
        recommendation="Activer l'authentification SMB et restreindre l'acc√®s."
    ))

    result.add_finding(Finding(
        title="Service FTP anonyme",
        description="Connexion FTP anonyme autoris√©e.",
        risk=RiskLevel.HIGH,
        port=21,
        service="vsftpd 3.0.3",
        recommendation="D√©sactiver l'acc√®s anonyme FTP."
    ))

    result.add_finding(Finding(
        title="Serveur web sans HTTPS",
        description="Le serveur web n'utilise pas de chiffrement TLS.",
        risk=RiskLevel.MEDIUM,
        port=80,
        service="Apache 2.4",
        recommendation="Activer HTTPS avec un certificat valide."
    ))

    result.add_finding(Finding(
        title="Version de serveur expos√©e",
        description="Les banni√®res de version sont visibles.",
        risk=RiskLevel.LOW,
        service="Multiple",
        recommendation="Masquer les versions dans les configurations."
    ))

    result.end_time = datetime.now()
    result.raw_output = "Nmap scan report for 192.168.1.100\nHost is up (0.00045s latency).\n..."

    return result


# Module initialization
__all__ = [
    'RiskLevel', 'Finding', 'ScanResult',
    'DemoMode', 'HTMLReportGenerator', 'TerminalOutput',
    'create_demo_finding', 'demo_report_example'
]
